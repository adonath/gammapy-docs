{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "\n",
    "<div class=\"alert alert-info\">\n",
    "\n",
    "**This is a fixed-text formatted version of a Jupyter notebook**\n",
    "\n",
    "- Try online [![Binder](https://static.mybinder.org/badge.svg)](https://mybinder.org/v2/gh/gammapy/gammapy-webpage/master?urlpath=lab/tree/spectrum_simulation.ipynb)\n",
    "- You can contribute with your own notebooks in this\n",
    "[GitHub repository](https://github.com/gammapy/gammapy/tree/master/docs/tutorials).\n",
    "- **Source files:**\n",
    "[spectrum_simulation.ipynb](../_static/notebooks/spectrum_simulation.ipynb) |\n",
    "[spectrum_simulation.py](../_static/notebooks/spectrum_simulation.py)\n",
    "</div>\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Spectrum simulation\n",
    "\n",
    "## Prerequisites\n",
    "\n",
    "- Knowledge of spectral extraction and datasets used in gammapy, see for instance the [spectral analysis tutorial](spectrum_analysis.ipynb)\n",
    "\n",
    "## Context\n",
    "\n",
    "To simulate a specific observation, it is not always necessary to simulate the full photon list. For many uses cases, simulating directly a reduced binned dataset is enough: the IRFs reduced in the correct geometry are combined with a source model to predict an actual number of counts per bin. The latter is then used to simulate a reduced dataset using Poisson probability distribution.\n",
    "\n",
    "This can be done to check the feasibility of a measurement, to test whether fitted parameters really provide a good fit to the data etc.\n",
    "\n",
    "Here we will see how to perform a 1D spectral simulation of a CTA observation, in particular, we will generate OFF observations following the template background stored in the CTA IRFs.\n",
    "\n",
    "**Objective: simulate a number of spectral ON-OFF observations of a source with a power-law spectral model with CTA using the CTA 1DC response, fit them with the assumed spectral model and check that the distribution of fitted parameters is consistent with the input values.**\n",
    "\n",
    "## Proposed approach:\n",
    "\n",
    "We will use the following classes:\n",
    "\n",
    "* `~gammapy.datasets.SpectrumDatasetOnOff`\n",
    "* `~gammapy.datasets.SpectrumDataset`\n",
    "* `~gammapy.irf.load_cta_irfs`\n",
    "* `~gammapy.modeling.models.PowerLawSpectralModel`"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Setup\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-10-27T15:47:04.456020Z",
     "iopub.status.busy": "2020-10-27T15:47:04.455450Z",
     "iopub.status.idle": "2020-10-27T15:47:04.735176Z",
     "shell.execute_reply": "2020-10-27T15:47:04.734077Z"
    }
   },
   "outputs": [],
   "source": [
    "%matplotlib inline\n",
    "import matplotlib.pyplot as plt"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-10-27T15:47:04.741442Z",
     "iopub.status.busy": "2020-10-27T15:47:04.740894Z",
     "iopub.status.idle": "2020-10-27T15:47:05.697791Z",
     "shell.execute_reply": "2020-10-27T15:47:05.696511Z"
    }
   },
   "outputs": [],
   "source": [
    "import numpy as np\n",
    "import astropy.units as u\n",
    "from astropy.coordinates import SkyCoord, Angle\n",
    "from regions import CircleSkyRegion\n",
    "from gammapy.datasets import SpectrumDatasetOnOff, SpectrumDataset, Datasets\n",
    "from gammapy.makers import SpectrumDatasetMaker\n",
    "from gammapy.modeling import Fit\n",
    "from gammapy.modeling.models import (\n",
    "    PowerLawSpectralModel,\n",
    "    SpectralModel,\n",
    "    SkyModel,\n",
    ")\n",
    "from gammapy.irf import load_cta_irfs\n",
    "from gammapy.data import Observation\n",
    "from gammapy.maps import MapAxis"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Simulation of a single spectrum\n",
    "\n",
    "To do a simulation, we need to define the observational parameters like the livetime, the offset, the assumed integration radius, the energy range to perform the simulation for and the choice of spectral model. We then use an in-memory observation which is convolved with the IRFs to get the predicted number of counts. This is Poission fluctuated using the `fake()` to get the simulated counts for each observation.  "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-10-27T15:47:05.705748Z",
     "iopub.status.busy": "2020-10-27T15:47:05.704590Z",
     "iopub.status.idle": "2020-10-27T15:47:05.706327Z",
     "shell.execute_reply": "2020-10-27T15:47:05.706821Z"
    }
   },
   "outputs": [],
   "source": [
    "# Define simulation parameters parameters\n",
    "livetime = 1 * u.h\n",
    "pointing = SkyCoord(0, 0, unit=\"deg\", frame=\"galactic\")\n",
    "offset = 0.5 * u.deg\n",
    "# Reconstructed and true energy axis\n",
    "energy_axis = MapAxis.from_edges(\n",
    "    np.logspace(-0.5, 1.0, 10), unit=\"TeV\", name=\"energy\", interp=\"log\"\n",
    ")\n",
    "energy_axis_true = MapAxis.from_edges(\n",
    "    np.logspace(-1.2, 2.0, 31), unit=\"TeV\", name=\"energy_true\", interp=\"log\"\n",
    ")\n",
    "\n",
    "on_region_radius = Angle(\"0.11 deg\")\n",
    "on_region = CircleSkyRegion(center=pointing, radius=on_region_radius)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-10-27T15:47:05.718529Z",
     "iopub.status.busy": "2020-10-27T15:47:05.717355Z",
     "iopub.status.idle": "2020-10-27T15:47:05.720090Z",
     "shell.execute_reply": "2020-10-27T15:47:05.720587Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "PowerLawSpectralModel\n",
      "\n",
      "   name     value         unit      min max frozen   error  \n",
      "--------- ---------- -------------- --- --- ------ ---------\n",
      "    index 3.0000e+00                nan nan  False 0.000e+00\n",
      "amplitude 2.5000e-12 cm-2 s-1 TeV-1 nan nan  False 0.000e+00\n",
      "reference 1.0000e+00            TeV nan nan   True 0.000e+00\n"
     ]
    }
   ],
   "source": [
    "# Define spectral model - a simple Power Law in this case\n",
    "model_simu = PowerLawSpectralModel(\n",
    "    index=3.0,\n",
    "    amplitude=2.5e-12 * u.Unit(\"cm-2 s-1 TeV-1\"),\n",
    "    reference=1 * u.TeV,\n",
    ")\n",
    "print(model_simu)\n",
    "# we set the sky model used in the dataset\n",
    "model = SkyModel(spectral_model=model_simu, name=\"source\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-10-27T15:47:05.725957Z",
     "iopub.status.busy": "2020-10-27T15:47:05.723509Z",
     "iopub.status.idle": "2020-10-27T15:47:05.817550Z",
     "shell.execute_reply": "2020-10-27T15:47:05.816567Z"
    }
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Invalid unit found in background table! Assuming (s-1 MeV-1 sr-1)\n"
     ]
    }
   ],
   "source": [
    "# Load the IRFs\n",
    "# In this simulation, we use the CTA-1DC irfs shipped with gammapy.\n",
    "irfs = load_cta_irfs(\n",
    "    \"$GAMMAPY_DATA/cta-1dc/caldb/data/cta/1dc/bcf/South_z20_50h/irf_file.fits\"\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-10-27T15:47:05.833800Z",
     "iopub.status.busy": "2020-10-27T15:47:05.832603Z",
     "iopub.status.idle": "2020-10-27T15:47:05.835046Z",
     "shell.execute_reply": "2020-10-27T15:47:05.835557Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Observation\n",
      "\n",
      "\tobs id            : 0 \n",
      " \ttstart            : 51544.00\n",
      "\ttstop             : 51544.04\n",
      "\tduration          : 3600.00 s\n",
      "\tpointing (icrs)   : 266.4 deg, -28.9 deg\n",
      "\n",
      "\tdeadtime fraction : 0.0%\n",
      "\n"
     ]
    }
   ],
   "source": [
    "obs = Observation.create(pointing=pointing, livetime=livetime, irfs=irfs)\n",
    "print(obs)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-10-27T15:47:05.856192Z",
     "iopub.status.busy": "2020-10-27T15:47:05.843143Z",
     "iopub.status.idle": "2020-10-27T15:47:05.917382Z",
     "shell.execute_reply": "2020-10-27T15:47:05.916382Z"
    }
   },
   "outputs": [],
   "source": [
    "# Make the SpectrumDataset\n",
    "dataset_empty = SpectrumDataset.create(\n",
    "    e_reco=energy_axis, e_true=energy_axis_true, region=on_region, name=\"obs-0\"\n",
    ")\n",
    "maker = SpectrumDatasetMaker(selection=[\"exposure\", \"edisp\", \"background\"])\n",
    "dataset = maker.run(dataset_empty, obs)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-10-27T15:47:05.922759Z",
     "iopub.status.busy": "2020-10-27T15:47:05.921770Z",
     "iopub.status.idle": "2020-10-27T15:47:05.933802Z",
     "shell.execute_reply": "2020-10-27T15:47:05.933363Z"
    }
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "No background model defined for dataset obs-0\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "SpectrumDataset\n",
      "---------------\n",
      "\n",
      "  Name                            : obs-0 \n",
      "\n",
      "  Total counts                    : 269 \n",
      "  Total predicted counts          : 272.26\n",
      "  Total background counts         : 22.35\n",
      "\n",
      "  Exposure min                    : 2.94e+08 m2 s\n",
      "  Exposure max                    : 1.83e+10 m2 s\n",
      "\n",
      "  Number of total bins            : 9 \n",
      "  Number of fit bins              : 9 \n",
      "\n",
      "  Fit statistic type              : cash\n",
      "  Fit statistic value (-2 log(L)) : -1567.93\n",
      "\n",
      "  Number of models                : 1 \n",
      "  Number of parameters            : 3\n",
      "  Number of free parameters       : 2\n",
      "\n",
      "  Component 0: SkyModel\n",
      "  \n",
      "    Name                      : source\n",
      "    Datasets names            : None\n",
      "    Spectral model type       : PowerLawSpectralModel\n",
      "    Spatial  model type       : \n",
      "    Temporal model type       : \n",
      "    Parameters:\n",
      "      index                   :   3.000              \n",
      "      amplitude               :   2.50e-12  1 / (cm2 s TeV)\n",
      "      reference    (frozen)   :   1.000  TeV         \n",
      "  \n",
      "  \n"
     ]
    }
   ],
   "source": [
    "# Set the model on the dataset, and fake\n",
    "dataset.models = model\n",
    "dataset.fake(random_state=42)\n",
    "print(dataset)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "You can see that backgound counts are now simulated"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### OnOff analysis\n",
    "\n",
    "To do `OnOff` spectral analysis, which is the usual science case, the standard would be to use `SpectrumDatasetOnOff`, which uses the acceptance to fake off-counts "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-10-27T15:47:05.939712Z",
     "iopub.status.busy": "2020-10-27T15:47:05.939183Z",
     "iopub.status.idle": "2020-10-27T15:47:05.965248Z",
     "shell.execute_reply": "2020-10-27T15:47:05.964778Z"
    }
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "No background model defined for dataset obs-0\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "SpectrumDatasetOnOff\n",
      "--------------------\n",
      "\n",
      "  Name                            : obs-0 \n",
      "\n",
      "  Total counts                    : 318 \n",
      "  Total predicted counts          : 294.32\n",
      "  Total background counts         : 22.06\n",
      "\n",
      "  Exposure min                    : 2.94e+08 m2 s\n",
      "  Exposure max                    : 1.83e+10 m2 s\n",
      "\n",
      "  Number of total bins            : 9 \n",
      "  Number of fit bins              : 9 \n",
      "\n",
      "  Acceptance mean                 : 1.000\n",
      "  Acceptance off                  : 45.000 \n",
      "\n",
      "  Fit statistic type              : wstat\n",
      "  Fit statistic value (-2 log(L)) : 8.70\n",
      "\n",
      "  Number of models                : 1 \n",
      "  Number of parameters            : 3\n",
      "  Number of free parameters       : 2\n",
      "\n",
      "  Component 0: SkyModel\n",
      "  \n",
      "    Name                      : source\n",
      "    Datasets names            : None\n",
      "    Spectral model type       : PowerLawSpectralModel\n",
      "    Spatial  model type       : \n",
      "    Temporal model type       : \n",
      "    Parameters:\n",
      "      index                   :   3.000              \n",
      "      amplitude               :   2.50e-12  1 / (cm2 s TeV)\n",
      "      reference    (frozen)   :   1.000  TeV         \n",
      "  \n",
      "  \n"
     ]
    }
   ],
   "source": [
    "dataset_onoff = SpectrumDatasetOnOff.from_spectrum_dataset(\n",
    "    dataset=dataset, acceptance=1, acceptance_off=5\n",
    ")\n",
    "dataset_onoff.fake(background_model=dataset.background_model)\n",
    "print(dataset_onoff)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "You can see that off counts are now simulated as well. We now simulate several spectra using the same set of observation conditions."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-10-27T15:47:06.329204Z",
     "iopub.status.busy": "2020-10-27T15:47:06.327804Z",
     "iopub.status.idle": "2020-10-27T15:47:06.912453Z",
     "shell.execute_reply": "2020-10-27T15:47:06.911664Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "CPU times: user 950 ms, sys: 36.1 ms, total: 987 ms\n",
      "Wall time: 938 ms\n"
     ]
    }
   ],
   "source": [
    "%%time\n",
    "\n",
    "n_obs = 100\n",
    "datasets = Datasets()\n",
    "\n",
    "for idx in range(n_obs):\n",
    "    dataset_onoff.fake(\n",
    "        random_state=idx, background_model=dataset.background_model\n",
    "    )\n",
    "    datasets.append(dataset_onoff.copy(name=f\"obs-{idx}\"))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-10-27T15:47:06.917007Z",
     "iopub.status.busy": "2020-10-27T15:47:06.916506Z",
     "iopub.status.idle": "2020-10-27T15:47:06.921569Z",
     "shell.execute_reply": "2020-10-27T15:47:06.921123Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "['obs-0', 'obs-1', 'obs-2', 'obs-3', 'obs-4', 'obs-5', 'obs-6', 'obs-7', 'obs-8', 'obs-9', 'obs-10', 'obs-11', 'obs-12', 'obs-13', 'obs-14', 'obs-15', 'obs-16', 'obs-17', 'obs-18', 'obs-19', 'obs-20', 'obs-21', 'obs-22', 'obs-23', 'obs-24', 'obs-25', 'obs-26', 'obs-27', 'obs-28', 'obs-29', 'obs-30', 'obs-31', 'obs-32', 'obs-33', 'obs-34', 'obs-35', 'obs-36', 'obs-37', 'obs-38', 'obs-39', 'obs-40', 'obs-41', 'obs-42', 'obs-43', 'obs-44', 'obs-45', 'obs-46', 'obs-47', 'obs-48', 'obs-49', 'obs-50', 'obs-51', 'obs-52', 'obs-53', 'obs-54', 'obs-55', 'obs-56', 'obs-57', 'obs-58', 'obs-59', 'obs-60', 'obs-61', 'obs-62', 'obs-63', 'obs-64', 'obs-65', 'obs-66', 'obs-67', 'obs-68', 'obs-69', 'obs-70', 'obs-71', 'obs-72', 'obs-73', 'obs-74', 'obs-75', 'obs-76', 'obs-77', 'obs-78', 'obs-79', 'obs-80', 'obs-81', 'obs-82', 'obs-83', 'obs-84', 'obs-85', 'obs-86', 'obs-87', 'obs-88', 'obs-89', 'obs-90', 'obs-91', 'obs-92', 'obs-93', 'obs-94', 'obs-95', 'obs-96', 'obs-97', 'obs-98', 'obs-99']\n"
     ]
    }
   ],
   "source": [
    "print(datasets.names)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Before moving on to the fit let's have a look at the simulated observations."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-10-27T15:47:07.072702Z",
     "iopub.status.busy": "2020-10-27T15:47:07.065782Z",
     "iopub.status.idle": "2020-10-27T15:47:08.927986Z",
     "shell.execute_reply": "2020-10-27T15:47:08.928404Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "Text(0.5, 0, 'excess')"
      ]
     },
     "execution_count": 1,
     "metadata": {},
     "output_type": "execute_result"
    },
    {
     "data": {
      "image/png": "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\n",
      "text/plain": [
       "<Figure size 864x288 with 3 Axes>"
      ]
     },
     "metadata": {
      "needs_background": "light"
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "table = datasets.info_table()\n",
    "\n",
    "fix, axes = plt.subplots(1, 3, figsize=(12, 4))\n",
    "axes[0].hist(table[\"counts\"])\n",
    "axes[0].set_xlabel(\"Counts\")\n",
    "axes[1].hist(table[\"counts_off\"])\n",
    "axes[1].set_xlabel(\"Counts Off\")\n",
    "axes[2].hist(table[\"excess\"])\n",
    "axes[2].set_xlabel(\"excess\");"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Now, we fit each simulated spectrum individually "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-10-27T15:47:08.933532Z",
     "iopub.status.busy": "2020-10-27T15:47:08.932785Z",
     "iopub.status.idle": "2020-10-27T15:47:22.807746Z",
     "shell.execute_reply": "2020-10-27T15:47:22.808173Z"
    }
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "No background model defined for dataset obs-0\n",
      "No background model defined for dataset obs-1\n",
      "No background model defined for dataset obs-2\n",
      "No background model defined for dataset obs-3\n",
      "No background model defined for dataset obs-4\n",
      "No background model defined for dataset obs-5\n",
      "No background model defined for dataset obs-6\n",
      "No background model defined for dataset obs-7\n",
      "No background model defined for dataset obs-8\n",
      "No background model defined for dataset obs-9\n",
      "No background model defined for dataset obs-10\n",
      "No background model defined for dataset obs-11\n",
      "No background model defined for dataset obs-12\n",
      "No background model defined for dataset obs-13\n",
      "No background model defined for dataset obs-14\n",
      "No background model defined for dataset obs-15\n",
      "No background model defined for dataset obs-16\n",
      "No background model defined for dataset obs-17\n",
      "No background model defined for dataset obs-18\n",
      "No background model defined for dataset obs-19\n",
      "No background model defined for dataset obs-20\n",
      "No background model defined for dataset obs-21\n",
      "No background model defined for dataset obs-22\n",
      "No background model defined for dataset obs-23\n",
      "No background model defined for dataset obs-24\n",
      "No background model defined for dataset obs-25\n",
      "No background model defined for dataset obs-26\n",
      "No background model defined for dataset obs-27\n",
      "No background model defined for dataset obs-28\n",
      "No background model defined for dataset obs-29\n",
      "No background model defined for dataset obs-30\n",
      "No background model defined for dataset obs-31\n",
      "No background model defined for dataset obs-32\n",
      "No background model defined for dataset obs-33\n",
      "No background model defined for dataset obs-34\n",
      "No background model defined for dataset obs-35\n",
      "No background model defined for dataset obs-36\n",
      "No background model defined for dataset obs-37\n",
      "No background model defined for dataset obs-38\n",
      "No background model defined for dataset obs-39\n",
      "No background model defined for dataset obs-40\n",
      "No background model defined for dataset obs-41\n",
      "No background model defined for dataset obs-42\n",
      "No background model defined for dataset obs-43\n",
      "No background model defined for dataset obs-44\n",
      "No background model defined for dataset obs-45\n",
      "No background model defined for dataset obs-46\n",
      "No background model defined for dataset obs-47\n",
      "No background model defined for dataset obs-48\n",
      "No background model defined for dataset obs-49\n",
      "No background model defined for dataset obs-50\n",
      "No background model defined for dataset obs-51\n",
      "No background model defined for dataset obs-52\n",
      "No background model defined for dataset obs-53\n",
      "No background model defined for dataset obs-54\n",
      "No background model defined for dataset obs-55\n",
      "No background model defined for dataset obs-56\n",
      "No background model defined for dataset obs-57\n",
      "No background model defined for dataset obs-58\n",
      "No background model defined for dataset obs-59\n",
      "No background model defined for dataset obs-60\n",
      "No background model defined for dataset obs-61\n",
      "No background model defined for dataset obs-62\n",
      "No background model defined for dataset obs-63\n",
      "No background model defined for dataset obs-64\n",
      "No background model defined for dataset obs-65\n",
      "No background model defined for dataset obs-66\n",
      "No background model defined for dataset obs-67\n",
      "No background model defined for dataset obs-68\n",
      "No background model defined for dataset obs-69\n",
      "No background model defined for dataset obs-70\n",
      "No background model defined for dataset obs-71\n",
      "No background model defined for dataset obs-72\n",
      "No background model defined for dataset obs-73\n",
      "No background model defined for dataset obs-74\n",
      "No background model defined for dataset obs-75\n",
      "No background model defined for dataset obs-76\n",
      "No background model defined for dataset obs-77\n",
      "No background model defined for dataset obs-78\n",
      "No background model defined for dataset obs-79\n",
      "No background model defined for dataset obs-80\n",
      "No background model defined for dataset obs-81\n",
      "No background model defined for dataset obs-82\n",
      "No background model defined for dataset obs-83\n",
      "No background model defined for dataset obs-84\n",
      "No background model defined for dataset obs-85\n",
      "No background model defined for dataset obs-86\n",
      "No background model defined for dataset obs-87\n",
      "No background model defined for dataset obs-88\n",
      "No background model defined for dataset obs-89\n",
      "No background model defined for dataset obs-90\n",
      "No background model defined for dataset obs-91\n",
      "No background model defined for dataset obs-92\n",
      "No background model defined for dataset obs-93\n",
      "No background model defined for dataset obs-94\n",
      "No background model defined for dataset obs-95\n",
      "No background model defined for dataset obs-96\n",
      "No background model defined for dataset obs-97\n",
      "No background model defined for dataset obs-98\n",
      "No background model defined for dataset obs-99\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "CPU times: user 14.1 s, sys: 383 ms, total: 14.5 s\n",
      "Wall time: 13.9 s\n"
     ]
    }
   ],
   "source": [
    "%%time\n",
    "results = []\n",
    "for dataset in datasets:\n",
    "    dataset.models = model.copy()\n",
    "    fit = Fit([dataset])\n",
    "    result = fit.optimize()\n",
    "    results.append(\n",
    "        {\n",
    "            \"index\": result.parameters[\"index\"].value,\n",
    "            \"amplitude\": result.parameters[\"amplitude\"].value,\n",
    "        }\n",
    "    )"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "We take a look at the distribution of the fitted indices. This matches very well with the spectrum that we initially injected."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-10-27T15:47:22.833216Z",
     "iopub.status.busy": "2020-10-27T15:47:22.832058Z",
     "iopub.status.idle": "2020-10-27T15:47:22.930143Z",
     "shell.execute_reply": "2020-10-27T15:47:22.930866Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "index: 3.007372502860302 += 0.08556154606802209\n"
     ]
    },
    {
     "data": {
      "image/png": "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\n",
      "text/plain": [
       "<Figure size 432x288 with 1 Axes>"
      ]
     },
     "metadata": {
      "needs_background": "light"
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "index = np.array([_[\"index\"] for _ in results])\n",
    "plt.hist(index, bins=10, alpha=0.5)\n",
    "plt.axvline(x=model_simu.parameters[\"index\"].value, color=\"red\")\n",
    "print(f\"index: {index.mean()} += {index.std()}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Exercises\n",
    "\n",
    "* Change the observation time to something longer or shorter. Does the observation and spectrum results change as you expected?\n",
    "* Change the spectral model, e.g. add a cutoff at 5 TeV, or put a steep-spectrum source with spectral index of 4.0\n",
    "* Simulate spectra with the spectral model we just defined. How much observation duration do you need to get back the injected parameters?"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.0"
  },
  "nbsphinx": {
   "orphan": true
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
