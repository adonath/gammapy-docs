{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "\n",
    "<div class=\"alert alert-info\">\n",
    "\n",
    "**This is a fixed-text formatted version of a Jupyter notebook**\n",
    "\n",
    "- Try online [![Binder](https://static.mybinder.org/badge.svg)](https://mybinder.org/v2/gh/gammapy/gammapy-webpage/master?urlpath=lab/tree/spectrum_simulation.ipynb)\n",
    "- You can contribute with your own notebooks in this\n",
    "[GitHub repository](https://github.com/gammapy/gammapy/tree/master/docs/tutorials).\n",
    "- **Source files:**\n",
    "[spectrum_simulation.ipynb](../_static/notebooks/spectrum_simulation.ipynb) |\n",
    "[spectrum_simulation.py](../_static/notebooks/spectrum_simulation.py)\n",
    "</div>\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Spectrum simulation\n",
    "\n",
    "## Prerequisites\n",
    "\n",
    "- Knowledge of spectral extraction and datasets used in gammapy, see for instance the [spectral analysis tutorial](spectrum_analysis.ipynb)\n",
    "\n",
    "## Context\n",
    "\n",
    "To simulate a specific observation, it is not always necessary to simulate the full photon list. For many uses cases, simulating directly a reduced binned dataset is enough: the IRFs reduced in the correct geometry are combined with a source model to predict an actual number of counts per bin. The latter is then used to simulate a reduced dataset using Poisson probability distribution.\n",
    "\n",
    "This can be done to check the feasibility of a measurement, to test whether fitted parameters really provide a good fit to the data etc.\n",
    "\n",
    "Here we will see how to perform a 1D spectral simulation of a CTA observation, in particular, we will generate OFF observations following the template background stored in the CTA IRFs.\n",
    "\n",
    "**Objective: simulate a number of spectral ON-OFF observations of a source with a power-law spectral model with CTA using the CTA 1DC response, fit them with the assumed spectral model and check that the distribution of fitted parameters is consistent with the input values.**\n",
    "\n",
    "## Proposed approach:\n",
    "\n",
    "We will use the following classes:\n",
    "\n",
    "* `~gammapy.datasets.SpectrumDatasetOnOff`\n",
    "* `~gammapy.datasets.SpectrumDataset`\n",
    "* `~gammapy.irf.load_cta_irfs`\n",
    "* `~gammapy.modeling.models.PowerLawSpectralModel`"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Setup\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-11-04T17:03:51.341723Z",
     "iopub.status.busy": "2020-11-04T17:03:51.336461Z",
     "iopub.status.idle": "2020-11-04T17:03:51.655026Z",
     "shell.execute_reply": "2020-11-04T17:03:51.655672Z"
    }
   },
   "outputs": [],
   "source": [
    "%matplotlib inline\n",
    "import matplotlib.pyplot as plt"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-11-04T17:03:51.661522Z",
     "iopub.status.busy": "2020-11-04T17:03:51.660618Z",
     "iopub.status.idle": "2020-11-04T17:03:52.762211Z",
     "shell.execute_reply": "2020-11-04T17:03:52.761391Z"
    }
   },
   "outputs": [],
   "source": [
    "import numpy as np\n",
    "import astropy.units as u\n",
    "from astropy.coordinates import SkyCoord, Angle\n",
    "from regions import CircleSkyRegion\n",
    "from gammapy.datasets import SpectrumDatasetOnOff, SpectrumDataset, Datasets\n",
    "from gammapy.makers import SpectrumDatasetMaker\n",
    "from gammapy.modeling import Fit\n",
    "from gammapy.modeling.models import (\n",
    "    PowerLawSpectralModel,\n",
    "    SkyModel,\n",
    ")\n",
    "from gammapy.irf import load_cta_irfs\n",
    "from gammapy.data import Observation\n",
    "from gammapy.maps import MapAxis"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Simulation of a single spectrum\n",
    "\n",
    "To do a simulation, we need to define the observational parameters like the livetime, the offset, the assumed integration radius, the energy range to perform the simulation for and the choice of spectral model. We then use an in-memory observation which is convolved with the IRFs to get the predicted number of counts. This is Poission fluctuated using the `fake()` to get the simulated counts for each observation.  "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-11-04T17:03:52.773352Z",
     "iopub.status.busy": "2020-11-04T17:03:52.771963Z",
     "iopub.status.idle": "2020-11-04T17:03:52.774004Z",
     "shell.execute_reply": "2020-11-04T17:03:52.774587Z"
    }
   },
   "outputs": [],
   "source": [
    "# Define simulation parameters parameters\n",
    "livetime = 1 * u.h\n",
    "\n",
    "pointing = SkyCoord(0, 0, unit=\"deg\", frame=\"galactic\")\n",
    "offset = 0.5 * u.deg\n",
    "\n",
    "# Reconstructed and true energy axis\n",
    "energy_axis = MapAxis.from_edges(\n",
    "    np.logspace(-0.5, 1.0, 10), unit=\"TeV\", name=\"energy\", interp=\"log\"\n",
    ")\n",
    "energy_axis_true = MapAxis.from_edges(\n",
    "    np.logspace(-1.2, 2.0, 31), unit=\"TeV\", name=\"energy_true\", interp=\"log\"\n",
    ")\n",
    "\n",
    "on_region_radius = Angle(\"0.11 deg\")\n",
    "\n",
    "center = pointing.directional_offset_by(\n",
    "    position_angle=0 * u.deg, separation=offset\n",
    ")\n",
    "on_region = CircleSkyRegion(center=center, radius=on_region_radius)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-11-04T17:03:52.792092Z",
     "iopub.status.busy": "2020-11-04T17:03:52.790860Z",
     "iopub.status.idle": "2020-11-04T17:03:52.794283Z",
     "shell.execute_reply": "2020-11-04T17:03:52.794878Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "PowerLawSpectralModel\n",
      "\n",
      "   name     value         unit      min max frozen   error  \n",
      "--------- ---------- -------------- --- --- ------ ---------\n",
      "    index 3.0000e+00                nan nan  False 0.000e+00\n",
      "amplitude 2.5000e-12 cm-2 s-1 TeV-1 nan nan  False 0.000e+00\n",
      "reference 1.0000e+00            TeV nan nan   True 0.000e+00\n"
     ]
    }
   ],
   "source": [
    "# Define spectral model - a simple Power Law in this case\n",
    "model_simu = PowerLawSpectralModel(\n",
    "    index=3.0,\n",
    "    amplitude=2.5e-12 * u.Unit(\"cm-2 s-1 TeV-1\"),\n",
    "    reference=1 * u.TeV,\n",
    ")\n",
    "print(model_simu)\n",
    "# we set the sky model used in the dataset\n",
    "model = SkyModel(spectral_model=model_simu, name=\"source\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-11-04T17:03:52.800159Z",
     "iopub.status.busy": "2020-11-04T17:03:52.799573Z",
     "iopub.status.idle": "2020-11-04T17:03:52.916941Z",
     "shell.execute_reply": "2020-11-04T17:03:52.916390Z"
    }
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Invalid unit found in background table! Assuming (s-1 MeV-1 sr-1)\n"
     ]
    }
   ],
   "source": [
    "# Load the IRFs\n",
    "# In this simulation, we use the CTA-1DC irfs shipped with gammapy.\n",
    "irfs = load_cta_irfs(\n",
    "    \"$GAMMAPY_DATA/cta-1dc/caldb/data/cta/1dc/bcf/South_z20_50h/irf_file.fits\"\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-11-04T17:03:52.937770Z",
     "iopub.status.busy": "2020-11-04T17:03:52.936219Z",
     "iopub.status.idle": "2020-11-04T17:03:52.939371Z",
     "shell.execute_reply": "2020-11-04T17:03:52.939921Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Observation\n",
      "\n",
      "\tobs id            : 0 \n",
      " \ttstart            : 51544.00\n",
      "\ttstop             : 51544.04\n",
      "\tduration          : 3600.00 s\n",
      "\tpointing (icrs)   : 266.4 deg, -28.9 deg\n",
      "\n",
      "\tdeadtime fraction : 0.0%\n",
      "\n"
     ]
    }
   ],
   "source": [
    "obs = Observation.create(pointing=pointing, livetime=livetime, irfs=irfs)\n",
    "print(obs)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-11-04T17:03:52.967897Z",
     "iopub.status.busy": "2020-11-04T17:03:52.948345Z",
     "iopub.status.idle": "2020-11-04T17:03:53.045124Z",
     "shell.execute_reply": "2020-11-04T17:03:53.044528Z"
    }
   },
   "outputs": [],
   "source": [
    "# Make the SpectrumDataset\n",
    "dataset_empty = SpectrumDataset.create(\n",
    "    e_reco=energy_axis, e_true=energy_axis_true, region=on_region, name=\"obs-0\"\n",
    ")\n",
    "maker = SpectrumDatasetMaker(selection=[\"exposure\", \"edisp\", \"background\"])\n",
    "\n",
    "dataset = maker.run(dataset_empty, obs)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-11-04T17:03:53.061192Z",
     "iopub.status.busy": "2020-11-04T17:03:53.049399Z",
     "iopub.status.idle": "2020-11-04T17:03:53.063429Z",
     "shell.execute_reply": "2020-11-04T17:03:53.064104Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "SpectrumDataset\n",
      "---------------\n",
      "\n",
      "  Name                            : obs-0 \n",
      "\n",
      "  Total counts                    : 298 \n",
      "  Total background counts         : 22.32\n",
      "  Total excess counts             : 275.68\n",
      "\n",
      "  Predicted counts                : 303.69\n",
      "  Predicted background counts     : 22.32\n",
      "  Predicted excess counts         : 281.37\n",
      "\n",
      "  Exposure min                    : 2.53e+08 m2 s\n",
      "  Exposure max                    : 1.77e+10 m2 s\n",
      "\n",
      "  Number of total bins            : 9 \n",
      "  Number of fit bins              : 9 \n",
      "\n",
      "  Fit statistic type              : cash\n",
      "  Fit statistic value (-2 log(L)) : -1811.58\n",
      "\n",
      "  Number of models                : 1 \n",
      "  Number of parameters            : 3\n",
      "  Number of free parameters       : 2\n",
      "\n",
      "  Component 0: SkyModel\n",
      "  \n",
      "    Name                      : source\n",
      "    Datasets names            : None\n",
      "    Spectral model type       : PowerLawSpectralModel\n",
      "    Spatial  model type       : \n",
      "    Temporal model type       : \n",
      "    Parameters:\n",
      "      index                   :   3.000              \n",
      "      amplitude               :   2.50e-12  1 / (cm2 s TeV)\n",
      "      reference    (frozen)   :   1.000  TeV         \n",
      "  \n",
      "  \n"
     ]
    }
   ],
   "source": [
    "# Set the model on the dataset, and fake\n",
    "dataset.models = model\n",
    "dataset.fake(random_state=42)\n",
    "print(dataset)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "You can see that backgound counts are now simulated"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### On-Off analysis\n",
    "\n",
    "To do an on off spectral analysis, which is the usual science case, the standard would be to use `SpectrumDatasetOnOff`, which uses the acceptance to fake off-counts "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-11-04T17:03:53.100820Z",
     "iopub.status.busy": "2020-11-04T17:03:53.072036Z",
     "iopub.status.idle": "2020-11-04T17:03:53.105483Z",
     "shell.execute_reply": "2020-11-04T17:03:53.104847Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "SpectrumDatasetOnOff\n",
      "--------------------\n",
      "\n",
      "  Name                            : obs-0 \n",
      "\n",
      "  Total counts                    : 310 \n",
      "  Total off counts                : 117.00\n",
      "  Total background counts         : 23.40\n",
      "  Total excess counts             : 286.60\n",
      "\n",
      "  Predicted counts                : 304.87\n",
      "  Predicted background counts     : 23.50\n",
      "  Predicted excess counts         : 281.37\n",
      "\n",
      "  Exposure min                    : 2.53e+08 m2 s\n",
      "  Exposure max                    : 1.77e+10 m2 s\n",
      "\n",
      "  Acceptance mean                 : 1.000\n",
      "  Acceptance off                  : 45.000\n",
      "\n",
      "  Number of total bins            : 9 \n",
      "  Number of fit bins              : 9 \n",
      "\n",
      "  Fit statistic type              : wstat\n",
      "  Fit statistic value (-2 log(L)) : 4.29\n",
      "\n",
      "  Number of models                : 1 \n",
      "  Number of parameters            : 3\n",
      "  Number of free parameters       : 2\n",
      "\n",
      "  Component 0: SkyModel\n",
      "  \n",
      "    Name                      : source\n",
      "    Datasets names            : None\n",
      "    Spectral model type       : PowerLawSpectralModel\n",
      "    Spatial  model type       : \n",
      "    Temporal model type       : \n",
      "    Parameters:\n",
      "      index                   :   3.000              \n",
      "      amplitude               :   2.50e-12  1 / (cm2 s TeV)\n",
      "      reference    (frozen)   :   1.000  TeV         \n",
      "  \n",
      "  \n"
     ]
    }
   ],
   "source": [
    "dataset_on_off = SpectrumDatasetOnOff.from_spectrum_dataset(\n",
    "    dataset=dataset, acceptance=1, acceptance_off=5\n",
    ")\n",
    "dataset_on_off.fake(npred_background=dataset.npred_background())\n",
    "print(dataset_on_off)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "You can see that off counts are now simulated as well. We now simulate several spectra using the same set of observation conditions."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-11-04T17:03:53.145300Z",
     "iopub.status.busy": "2020-11-04T17:03:53.140373Z",
     "iopub.status.idle": "2020-11-04T17:03:53.959764Z",
     "shell.execute_reply": "2020-11-04T17:03:53.959156Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "CPU times: user 832 ms, sys: 20.2 ms, total: 852 ms\n",
      "Wall time: 846 ms\n"
     ]
    }
   ],
   "source": [
    "%%time\n",
    "\n",
    "n_obs = 100\n",
    "datasets = Datasets()\n",
    "\n",
    "for idx in range(n_obs):\n",
    "    dataset_on_off.fake(\n",
    "        random_state=idx, npred_background=dataset.npred_background()\n",
    "    )\n",
    "    dataset_fake = dataset_on_off.copy(name=f\"obs-{idx}\")\n",
    "    dataset_fake.meta_table[\"OBS_ID\"] = [idx]\n",
    "    datasets.append(dataset_fake)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-11-04T17:03:54.050293Z",
     "iopub.status.busy": "2020-11-04T17:03:54.043630Z",
     "iopub.status.idle": "2020-11-04T17:03:56.454625Z",
     "shell.execute_reply": "2020-11-04T17:03:56.454060Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<i>Table length=100</i>\n",
       "<table id=\"table140547637872120\" class=\"table-striped table-bordered table-condensed\">\n",
       "<thead><tr><th>name</th><th>counts</th><th>background</th><th>excess</th><th>sqrt_ts</th><th>npred</th><th>npred_background</th><th>npred_signal</th><th>exposure_min</th><th>exposure_max</th><th>livetime</th><th>ontime</th><th>counts_rate</th><th>background_rate</th><th>excess_rate</th><th>n_bins</th><th>n_fit_bins</th><th>stat_type</th><th>stat_sum</th><th>counts_off</th><th>acceptance</th><th>acceptance_off</th><th>alpha</th></tr></thead>\n",
       "<thead><tr><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th>m2 s</th><th>m2 s</th><th>s</th><th>s</th><th>1 / s</th><th>1 / s</th><th>1 / s</th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead>\n",
       "<thead><tr><th>str6</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>float64</th><th>int64</th><th>int64</th><th>str5</th><th>float64</th><th>int64</th><th>float64</th><th>float64</th><th>float64</th></tr></thead>\n",
       "<tr><td>obs-0</td><td>317.0</td><td>18.400000000000002</td><td>298.6</td><td>27.08240194504324</td><td>300.0237217925292</td><td>18.65354630236477</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.08805555555555555</td><td>0.005111111111111111</td><td>0.08294444444444445</td><td>9</td><td>9</td><td>wstat</td><td>9.917001109718026</td><td>92</td><td>9.0</td><td>44.99999999999999</td><td>0.2</td></tr>\n",
       "<tr><td>obs-1</td><td>275.0</td><td>22.0</td><td>253.0</td><td>23.76785365487285</td><td>302.9527632060656</td><td>21.58258771590118</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.0763888888888889</td><td>0.006111111111111111</td><td>0.07027777777777777</td><td>9</td><td>9</td><td>wstat</td><td>8.818660828556197</td><td>110</td><td>9.0</td><td>45.0</td><td>0.2</td></tr>\n",
       "<tr><td>obs-2</td><td>293.0</td><td>20.6</td><td>272.4</td><td>25.17110555404655</td><td>301.8397348729254</td><td>20.469559382761037</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.08138888888888889</td><td>0.005722222222222222</td><td>0.07566666666666666</td><td>9</td><td>9</td><td>wstat</td><td>7.359111002998524</td><td>103</td><td>9.0</td><td>45.0</td><td>0.2</td></tr>\n",
       "<tr><td>obs-3</td><td>280.0</td><td>22.4</td><td>257.6</td><td>23.982951737405376</td><td>303.45571390260335</td><td>22.085538412438964</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.07777777777777778</td><td>0.006222222222222222</td><td>0.07155555555555557</td><td>9</td><td>9</td><td>wstat</td><td>11.832983489177304</td><td>112</td><td>9.0</td><td>45.0</td><td>0.2</td></tr>\n",
       "<tr><td>obs-4</td><td>337.0</td><td>20.6</td><td>316.4</td><td>27.682709945184747</td><td>302.2812841625807</td><td>20.911108672416216</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.09361111111111112</td><td>0.005722222222222222</td><td>0.08788888888888888</td><td>9</td><td>9</td><td>wstat</td><td>17.867103727171298</td><td>103</td><td>9.0</td><td>45.0</td><td>0.2</td></tr>\n",
       "<tr><td>obs-5</td><td>283.0</td><td>24.400000000000002</td><td>258.6</td><td>23.727154782347895</td><td>305.3838138459025</td><td>24.013638355738106</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.07861111111111112</td><td>0.006777777777777778</td><td>0.07183333333333335</td><td>9</td><td>9</td><td>wstat</td><td>8.00519618043828</td><td>122</td><td>9.0</td><td>44.99999999999999</td><td>0.2</td></tr>\n",
       "<tr><td>obs-6</td><td>330.0</td><td>22.400000000000006</td><td>307.6</td><td>26.889184475727866</td><td>304.171682312679</td><td>22.8015068225146</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.09166666666666666</td><td>0.006222222222222224</td><td>0.08544444444444445</td><td>9</td><td>9</td><td>wstat</td><td>10.098766444429586</td><td>112</td><td>9.0</td><td>44.999999999999986</td><td>0.2</td></tr>\n",
       "<tr><td>obs-7</td><td>283.0</td><td>26.000000000000004</td><td>257.0</td><td>23.389178133235443</td><td>307.02186335244863</td><td>25.65168786228425</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.07861111111111112</td><td>0.007222222222222224</td><td>0.07138888888888889</td><td>9</td><td>9</td><td>wstat</td><td>4.310899779189115</td><td>130</td><td>9.0</td><td>44.99999999999999</td><td>0.2</td></tr>\n",
       "<tr><td>obs-8</td><td>308.0</td><td>23.400000000000002</td><td>284.6</td><td>25.42049273328333</td><td>304.8351782861283</td><td>23.46500279596388</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.08555555555555555</td><td>0.006500000000000001</td><td>0.07905555555555556</td><td>9</td><td>9</td><td>wstat</td><td>4.142947213517404</td><td>117</td><td>9.0</td><td>44.99999999999999</td><td>0.2</td></tr>\n",
       "<tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>\n",
       "<tr><td>obs-90</td><td>286.0</td><td>19.000000000000004</td><td>267.0</td><td>25.131221887043438</td><td>300.266002711119</td><td>18.895827220954608</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.07944444444444444</td><td>0.005277777777777779</td><td>0.07416666666666667</td><td>9</td><td>9</td><td>wstat</td><td>6.7243882280608345</td><td>95</td><td>9.0</td><td>44.99999999999999</td><td>0.2</td></tr>\n",
       "<tr><td>obs-91</td><td>285.0</td><td>25.200000000000003</td><td>259.8</td><td>23.67754591931069</td><td>306.2191485971411</td><td>24.848973106976626</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.07916666666666666</td><td>0.007000000000000001</td><td>0.07216666666666667</td><td>9</td><td>9</td><td>wstat</td><td>14.577940826871794</td><td>126</td><td>9.0</td><td>44.99999999999999</td><td>0.2</td></tr>\n",
       "<tr><td>obs-92</td><td>313.0</td><td>23.6</td><td>289.4</td><td>25.664935420194176</td><td>305.0583273409919</td><td>23.688151850827474</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.08694444444444445</td><td>0.006555555555555556</td><td>0.08038888888888888</td><td>9</td><td>9</td><td>wstat</td><td>6.304646568308117</td><td>118</td><td>9.0</td><td>45.0</td><td>0.2</td></tr>\n",
       "<tr><td>obs-93</td><td>302.0</td><td>18.8</td><td>283.2</td><td>26.123867522605497</td><td>300.1259513871509</td><td>18.75577589698646</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.08388888888888889</td><td>0.005222222222222223</td><td>0.07866666666666666</td><td>9</td><td>9</td><td>wstat</td><td>5.8650342902905415</td><td>94</td><td>9.0</td><td>45.0</td><td>0.2</td></tr>\n",
       "<tr><td>obs-94</td><td>322.0</td><td>22.0</td><td>300.0</td><td>26.5292481657426</td><td>303.6642079652339</td><td>22.294032475069507</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.08944444444444444</td><td>0.006111111111111111</td><td>0.08333333333333333</td><td>9</td><td>9</td><td>wstat</td><td>10.005883760873093</td><td>110</td><td>9.0</td><td>45.0</td><td>0.2</td></tr>\n",
       "<tr><td>obs-95</td><td>305.0</td><td>24.600000000000005</td><td>280.4</td><td>24.98804632088198</td><td>305.8930204465737</td><td>24.522844956409255</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.08472222222222223</td><td>0.0068333333333333345</td><td>0.07788888888888888</td><td>9</td><td>9</td><td>wstat</td><td>5.627799171046492</td><td>123</td><td>9.0</td><td>44.99999999999999</td><td>0.2</td></tr>\n",
       "<tr><td>obs-96</td><td>301.0</td><td>23.6</td><td>277.4</td><td>24.969845969421428</td><td>305.03995926454917</td><td>23.669783774384793</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.08361111111111111</td><td>0.006555555555555556</td><td>0.07705555555555554</td><td>9</td><td>9</td><td>wstat</td><td>5.511772031205281</td><td>118</td><td>9.0</td><td>45.0</td><td>0.2</td></tr>\n",
       "<tr><td>obs-97</td><td>290.0</td><td>18.8</td><td>271.2</td><td>25.417982194454826</td><td>300.0933776554592</td><td>18.723202165294804</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.08055555555555556</td><td>0.005222222222222223</td><td>0.07533333333333334</td><td>9</td><td>9</td><td>wstat</td><td>5.667231272491763</td><td>94</td><td>9.0</td><td>45.0</td><td>0.2</td></tr>\n",
       "<tr><td>obs-98</td><td>301.0</td><td>20.400000000000002</td><td>280.6</td><td>25.687832964675007</td><td>301.75614855910493</td><td>20.38597306894053</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.08361111111111111</td><td>0.005666666666666667</td><td>0.07794444444444446</td><td>9</td><td>9</td><td>wstat</td><td>7.14214115301789</td><td>102</td><td>9.0</td><td>44.99999999999999</td><td>0.2</td></tr>\n",
       "<tr><td>obs-99</td><td>323.0</td><td>20.8</td><td>302.2</td><td>26.85707842376871</td><td>302.47669176504246</td><td>21.106516274878086</td><td>281.3701754901644</td><td>252718170.97287494</td><td>17719697919.599255</td><td>3600.0</td><td>3600.0</td><td>0.08972222222222222</td><td>0.005777777777777778</td><td>0.08394444444444445</td><td>9</td><td>9</td><td>wstat</td><td>5.059623929851592</td><td>104</td><td>9.0</td><td>45.0</td><td>0.2</td></tr>\n",
       "</table>"
      ],
      "text/plain": [
       "<Table length=100>\n",
       " name   counts     background     ... acceptance   acceptance_off    alpha \n",
       "                                  ...                                      \n",
       " str6  float64      float64       ...  float64        float64       float64\n",
       "------ ------- ------------------ ... ---------- ------------------ -------\n",
       " obs-0   317.0 18.400000000000002 ...        9.0  44.99999999999999     0.2\n",
       " obs-1   275.0               22.0 ...        9.0               45.0     0.2\n",
       " obs-2   293.0               20.6 ...        9.0               45.0     0.2\n",
       " obs-3   280.0               22.4 ...        9.0               45.0     0.2\n",
       " obs-4   337.0               20.6 ...        9.0               45.0     0.2\n",
       " obs-5   283.0 24.400000000000002 ...        9.0  44.99999999999999     0.2\n",
       " obs-6   330.0 22.400000000000006 ...        9.0 44.999999999999986     0.2\n",
       " obs-7   283.0 26.000000000000004 ...        9.0  44.99999999999999     0.2\n",
       " obs-8   308.0 23.400000000000002 ...        9.0  44.99999999999999     0.2\n",
       "   ...     ...                ... ...        ...                ...     ...\n",
       "obs-90   286.0 19.000000000000004 ...        9.0  44.99999999999999     0.2\n",
       "obs-91   285.0 25.200000000000003 ...        9.0  44.99999999999999     0.2\n",
       "obs-92   313.0               23.6 ...        9.0               45.0     0.2\n",
       "obs-93   302.0               18.8 ...        9.0               45.0     0.2\n",
       "obs-94   322.0               22.0 ...        9.0               45.0     0.2\n",
       "obs-95   305.0 24.600000000000005 ...        9.0  44.99999999999999     0.2\n",
       "obs-96   301.0               23.6 ...        9.0               45.0     0.2\n",
       "obs-97   290.0               18.8 ...        9.0               45.0     0.2\n",
       "obs-98   301.0 20.400000000000002 ...        9.0  44.99999999999999     0.2\n",
       "obs-99   323.0               20.8 ...        9.0               45.0     0.2"
      ]
     },
     "execution_count": 1,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "table = datasets.info_table()\n",
    "table"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Before moving on to the fit let's have a look at the simulated observations."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-11-04T17:03:56.460267Z",
     "iopub.status.busy": "2020-11-04T17:03:56.459346Z",
     "iopub.status.idle": "2020-11-04T17:03:56.977494Z",
     "shell.execute_reply": "2020-11-04T17:03:56.978205Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "Text(0.5, 0, 'excess')"
      ]
     },
     "execution_count": 1,
     "metadata": {},
     "output_type": "execute_result"
    },
    {
     "data": {
      "image/png": "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\n",
      "text/plain": [
       "<Figure size 864x288 with 3 Axes>"
      ]
     },
     "metadata": {
      "needs_background": "light"
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "fix, axes = plt.subplots(1, 3, figsize=(12, 4))\n",
    "axes[0].hist(table[\"counts\"])\n",
    "axes[0].set_xlabel(\"Counts\")\n",
    "axes[1].hist(table[\"counts_off\"])\n",
    "axes[1].set_xlabel(\"Counts Off\")\n",
    "axes[2].hist(table[\"excess\"])\n",
    "axes[2].set_xlabel(\"excess\");"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Now, we fit each simulated spectrum individually "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-11-04T17:03:56.990758Z",
     "iopub.status.busy": "2020-11-04T17:03:56.982887Z",
     "iopub.status.idle": "2020-11-04T17:04:13.728410Z",
     "shell.execute_reply": "2020-11-04T17:04:13.729055Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "CPU times: user 16.7 s, sys: 35 ms, total: 16.8 s\n",
      "Wall time: 16.7 s\n"
     ]
    }
   ],
   "source": [
    "%%time\n",
    "results = []\n",
    "\n",
    "for dataset in datasets:\n",
    "    dataset.models = model.copy()\n",
    "    fit = Fit([dataset])\n",
    "    result = fit.optimize()\n",
    "    results.append(\n",
    "        {\n",
    "            \"index\": result.parameters[\"index\"].value,\n",
    "            \"amplitude\": result.parameters[\"amplitude\"].value,\n",
    "        }\n",
    "    )"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "We take a look at the distribution of the fitted indices. This matches very well with the spectrum that we initially injected."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2020-11-04T17:04:13.765921Z",
     "iopub.status.busy": "2020-11-04T17:04:13.762505Z",
     "iopub.status.idle": "2020-11-04T17:04:13.886356Z",
     "shell.execute_reply": "2020-11-04T17:04:13.885804Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "index: 3.0036666673436003 += 0.08075110145615079\n"
     ]
    },
    {
     "data": {
      "image/png": "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\n",
      "text/plain": [
       "<Figure size 432x288 with 1 Axes>"
      ]
     },
     "metadata": {
      "needs_background": "light"
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "index = np.array([_[\"index\"] for _ in results])\n",
    "plt.hist(index, bins=10, alpha=0.5)\n",
    "plt.axvline(x=model_simu.parameters[\"index\"].value, color=\"red\")\n",
    "print(f\"index: {index.mean()} += {index.std()}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Exercises\n",
    "\n",
    "* Change the observation time to something longer or shorter. Does the observation and spectrum results change as you expected?\n",
    "* Change the spectral model, e.g. add a cutoff at 5 TeV, or put a steep-spectrum source with spectral index of 4.0\n",
    "* Simulate spectra with the spectral model we just defined. How much observation duration do you need to get back the injected parameters?"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.0"
  },
  "nbsphinx": {
   "orphan": true
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
